<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise Incident Intelligence & Business Analytics Platform</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <style>
        :root {
            --primary: #667eea;
            --primary-dark: #5a67d8;
            --secondary: #764ba2;
            --success: #48bb78;
            --warning: #ed8936;
            --danger: #f56565;
            --info: #4299e1;
            --dark: #2d3748;
            --light: #f7fafc;
            --bg-main: #f5f7fa;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --card-bg: #ffffff;
            --border: #e2e8f0;
        }

        [data-theme="dark"] {
            --bg-main: #1a202c;
            --card-bg: #2d3748;
            --text-primary: #f7fafc;
            --text-secondary: #a0aec0;
            --border: #4a5568;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 { 
            font-size: 1.8em; 
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }
        
        .status-live { 
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #00ff88;
            border-radius: 50%;
            margin-right: 12px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse { 
            0%, 100% { opacity: 1; transform: scale(1); } 
            50% { opacity: 0.7; transform: scale(1.1); } 
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .theme-toggle {
            background: rgba(255,255,255,0.2);
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .theme-toggle:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        
        .alert-bar {
            background: linear-gradient(90deg, #fff3cd, #fef5e7);
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 12px 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-icon {
            width: 20px;
            height: 20px;
            background: #f6ad55;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
        
        .main-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 30px;
            background: var(--card-bg);
            border-radius: 16px;
            padding: 6px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid var(--border);
        }
        
        .main-tab {
            flex: 1;
            padding: 16px 24px;
            background: transparent;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1em;
            transition: all 0.3s;
            color: var(--text-secondary);
            position: relative;
        }
        
        .main-tab.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transform: translateY(-2px);
        }
        
        .main-tab:hover:not(.active) {
            background: var(--bg-main);
            color: var(--text-primary);
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .sub-tabs {
            display: flex;
            gap: 2px;
            margin-bottom: 25px;
            background: var(--card-bg);
            border-radius: 12px;
            padding: 4px;
            border: 1px solid var(--border);
        }
        
        .sub-tab {
            flex: 1;
            padding: 10px 16px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            color: var(--text-secondary);
        }
        
        .sub-tab.active {
            background: var(--primary);
            color: white;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }
        
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }
        
        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--text-primary);
            line-height: 1;
            margin-bottom: 8px;
        }
        
        .metric-label {
            color: var(--text-secondary);
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .metric-change {
            font-size: 0.85em;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .metric-change.positive { color: var(--success); }
        .metric-change.negative { color: var(--danger); }
        .metric-change.neutral { color: var(--info); }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .charts-grid-triple {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid var(--border);
            transition: all 0.3s;
        }
        
        .chart-container:hover {
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }
        
        .chart-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-canvas { 
            width: 100%; 
            height: 300px; 
        }
        
        .chart-canvas-small { 
            width: 100%; 
            height: 250px; 
        }
        
        .incident-stream {
            max-height: 400px;
            overflow-y: auto;
            background: var(--bg-main);
            border-radius: 12px;
            padding: 16px;
        }
        
        .incident-item {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid var(--primary);
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid var(--border);
        }
        
        .incident-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .incident-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .incident-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95em;
        }
        
        .severity-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .severity-critical { background: #fee; color: #c53030; }
        .severity-major { background: #fffaf0; color: #dd6b20; }
        .severity-medium { background: #faf5ff; color: #805ad5; }
        .severity-minor { background: #f0fff4; color: #38a169; }
        
        .incident-meta {
            font-size: 0.8em;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }
        
        .opportunity-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            border-left: 4px solid var(--success);
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid var(--border);
        }
        
        .opportunity-card:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.2);
        }
        
        .opportunity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .opportunity-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.1em;
        }
        
        .opportunity-value {
            background: var(--success);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85em;
        }
        
        .opportunity-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            font-size: 0.85em;
            color: var(--text-secondary);
        }
        
        .opportunity-description {
            color: var(--text-primary);
            line-height: 1.5;
        }
        
        @media (max-width: 1200px) {
            .charts-grid { grid-template-columns: 1fr; }
            .charts-grid-triple { grid-template-columns: 1fr 1fr; }
        }
        
        @media (max-width: 768px) {
            .main-tabs { flex-direction: column; }
            .charts-grid-triple { grid-template-columns: 1fr; }
            .metrics-grid { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
        }
    </style>
</head>
<body data-theme="light">
    <div class="header">
        <div class="header-content">
            <div>
                <h1><span class="status-live"></span>Enterprise Incident Intelligence Platform</h1>
                <p>Advanced ML Analytics & Business Intelligence</p>
            </div>
            <div class="header-controls">
                <button class="theme-toggle" onclick="toggleTheme()">🌙 Dark Mode</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="alert-bar" id="alertBar">
            <div class="alert-icon">!</div>
            <span id="alertText">System Online: Loading real-time incident data...</span>
        </div>

        <div class="main-tabs">
            <button class="main-tab active" onclick="switchMainTab('incident-intelligence')">🔍 Incident Intelligence</button>
            <button class="main-tab" onclick="switchMainTab('business-opportunities')">💡 Business Opportunities</button>
        </div>

        <!-- INCIDENT INTELLIGENCE TAB -->
        <div id="incident-intelligence" class="tab-content active">
            <div class="sub-tabs">
                <button class="sub-tab active" onclick="switchSubTab('overview')">Overview</button>
                <button class="sub-tab" onclick="switchSubTab('real-time')">Real-time</button>
                <button class="sub-tab" onclick="switchSubTab('analytics')">Analytics</button>
            </div>

            <!-- Overview Sub-tab -->
            <div id="overview" class="tab-content active">
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="totalIncidents">0</div>
                        <div class="metric-label">Total Incidents</div>
                        <div class="metric-change neutral" id="incidentsChange">Loading...</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="criticalActive">0</div>
                        <div class="metric-label">Critical Issues</div>
                        <div class="metric-change negative" id="criticalChange">Loading...</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="avgResolution">0m</div>
                        <div class="metric-label">Avg Resolution</div>
                        <div class="metric-change positive" id="resolutionChange">Loading...</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="totalImpact">£0</div>
                        <div class="metric-label">Total Impact</div>
                        <div class="metric-change negative" id="impactChange">Loading...</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="mlConfidence">0%</div>
                        <div class="metric-label">ML Confidence</div>
                        <div class="metric-change positive" id="confidenceChange">Loading...</div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-container">
                        <div class="chart-title">📊 Incident Trends & Impact Analysis</div>
                        <div id="trendChart" class="chart-canvas"></div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">🏢 Provider Reliability</div>
                        <div id="providerChart" class="chart-canvas"></div>
                    </div>
                </div>

                <div class="charts-grid-triple">
                    <div class="chart-container">
                        <div class="chart-title">⚡ Severity Distribution</div>
                        <div id="severityChart" class="chart-canvas-small"></div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">💰 Error Type Impact</div>
                        <div id="errorTypeChart" class="chart-canvas-small"></div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">📈 Generation Rate</div>
                        <div id="generationChart" class="chart-canvas-small"></div>
                    </div>
                </div>
            </div>

            <!-- Real-time Sub-tab -->
            <div id="real-time" class="tab-content">
                <div class="charts-grid">
                    <div class="chart-container">
                        <div class="chart-title">📡 Live Incident Stream</div>
                        <div class="incident-stream" id="incidentStream">
                            <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                                Loading recent incidents...
                            </div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">⚡ System Performance</div>
                        <div id="systemStatsChart" class="chart-canvas"></div>
                    </div>
                </div>
            </div>

            <!-- Analytics Sub-tab -->
            <div id="analytics" class="tab-content">
                <div class="charts-grid-triple">
                    <div class="chart-container">
                        <div class="chart-title">📊 Impact Distribution</div>
                        <div id="statisticalChart" class="chart-canvas-small"></div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">🎯 Provider Clustering</div>
                        <div id="clusteringChart" class="chart-canvas-small"></div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">🚨 Anomaly Detection</div>
                        <div id="anomalyChart" class="chart-canvas-small"></div>
                    </div>
                </div>
                
                <div class="charts-grid">
                    <div class="chart-container">
                        <div class="chart-title">🔮 7-Day Forecast</div>
                        <div id="forecastChart" class="chart-canvas"></div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">🧠 ML Feature Importance</div>
                        <div id="featureImportanceChart" class="chart-canvas"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- BUSINESS OPPORTUNITIES TAB -->
        <div id="business-opportunities" class="tab-content">
            <div class="sub-tabs">
                <button class="sub-tab active" onclick="switchSubTab('opportunities-overview')">Market Analysis</button>
            </div>

            <!-- Opportunities Overview -->
            <div id="opportunities-overview" class="tab-content active">
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="totalRevenue">£0</div>
                        <div class="metric-label">Revenue Potential</div>
                        <div class="metric-change positive">🎯 AI-Calculated</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="opportunityCount">0</div>
                        <div class="metric-label">Opportunities</div>
                        <div class="metric-change neutral">💡 ML-Discovered</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="avgROI">0%</div>
                        <div class="metric-label">Average ROI</div>
                        <div class="metric-change positive">💰 Expected Return</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="implementationCost">£0</div>
                        <div class="metric-label">Implementation Cost</div>
                        <div class="metric-change neutral">💼 Investment Required</div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">🚀 Business Opportunities</div>
                    <div id="opportunitiesStream" class="incident-stream" style="max-height: 500px;">
                        <!-- Opportunities populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Incident Detail Modal -->
    <div id="incidentModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; backdrop-filter: blur(5px);">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--card-bg); border-radius: 16px; padding: 30px; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); border: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: var(--text-primary); margin: 0; font-size: 1.5em;">🔍 Incident Details</h2>
                <button onclick="closeIncidentModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary); padding: 5px; border-radius: 50%; transition: all 0.3s; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='var(--bg-main)'" onmouseout="this.style.background='none'">&times;</button>
            </div>
            <div id="incidentModalContent">
                <!-- Content populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        let currentMainTab = 'incident-intelligence';
        let currentSubTab = 'overview';
        let updateInterval;
        let currentIncidents = [];

        // Modal Functions
        function showIncidentDetails(incident) {
            console.log('Showing incident details:', incident); // Debug log
            
            const modalContent = document.getElementById('incidentModalContent');
            if (!modalContent) {
                console.error('Modal content element not found');
                return;
            }
            
            // Generate additional details for the modal
            const additionalDetails = {
                ticket_id: `INC-${String(incident.id).padStart(6, '0')}`,
                status: ['Open', 'In Progress', 'Resolved', 'Closed'][Math.floor(Math.random() * 4)],
                assigned_to: ['John Smith', 'Sarah Johnson', 'Mike Chen', 'Lisa Rodriguez'][Math.floor(Math.random() * 4)],
                customers_affected: Math.floor(Math.random() * 10000 + 100),
                resolution_steps: [
                    'Initial investigation started',
                    'Root cause identified',
                    'Temporary fix implemented',
                    'Monitoring for stability'
                ],
                error_details: `${incident.error_type} occurred in ${incident.service_provider} infrastructure. System experienced ${incident.severity} level disruption affecting multiple services.`,
                root_cause: ['Configuration Error', 'Hardware Failure', 'Network Issue', 'Software Bug', 'Third-party Service'][Math.floor(Math.random() * 5)],
                tags: ['#infrastructure', '#performance', '#customer-impact'],
                escalation_level: incident.severity === 'critical' ? 'Level 3 - Executive' : 
                                 incident.severity === 'major' ? 'Level 2 - Management' : 'Level 1 - Standard'
            };
            
            modalContent.innerHTML = `
                <div style="display: grid; gap: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <strong style="color: var(--primary); font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px;">Ticket ID</strong>
                            <p style="margin: 5px 0; color: var(--text-primary); font-family: monospace; font-size: 1.1em;">${additionalDetails.ticket_id}</p>
                        </div>
                        <div>
                            <strong style="color: var(--primary); font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px;">Status</strong>
                            <p style="margin: 5px 0; color: var(--text-primary);">
                                <span style="background: ${additionalDetails.status === 'Resolved' ? 'var(--success)' : additionalDetails.status === 'Open' ? 'var(--danger)' : 'var(--warning)'}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8em;">${additionalDetails.status}</span>
                            </p>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <strong style="color: var(--primary); font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px;">Error Type</strong>
                            <p style="margin: 5px 0; color: var(--text-primary); font-size: 1.1em;">${incident.error_type || 'Unknown'}</p>
                        </div>
                        <div>
                            <strong style="color: var(--primary); font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px;">Severity</strong>
                            <p style="margin: 5px 0;">
                                <span class="severity-badge severity-${incident.severity || 'unknown'}" style="font-size: 0.8em;">${(incident.severity || 'unknown').toUpperCase()}</span>
                            </p>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <strong style="color: var(--primary); font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px;">Service Provider</strong>
                            <p style="margin: 5px 0; color: var(--text-primary);">${incident.service_provider || 'Unknown'}</p>
                        </div>
                        <div>
                            <strong style="color: var(--primary); font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px;">Assigned To</strong>
                            <p style="margin: 5px 0; color: var(--text-primary);">${additionalDetails.assigned_to}</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div>
                            <strong style="color: var(--primary); font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px;">Business Impact</strong>
                            <p style="margin: 5px 0; color: var(--danger); font-weight: 600; font-size: 1.1em;">£${(incident.business_impact || 0).toLocaleString()}</p>
                        </div>
                        <div>
                            <strong style="color: var(--primary); font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px;">Duration</strong>
                            <p style="margin: 5px 0; color: var(--text-primary); font-weight: 600;">${incident.duration_minutes || 0} minutes</p>
                        </div>
                        <div>
                            <strong style="color: var(--primary); font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px;">Customers Affected</strong>
                            <p style="margin: 5px 0; color: var(--danger); font-weight: 600;">${additionalDetails.customers_affected.toLocaleString()}</p>
                        </div>
                    </div>
                    
                    <div>
                        <strong style="color: var(--primary); font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; display: block;">Timestamp</strong>
                        <p style="margin: 5px 0; color: var(--text-secondary); font-family: monospace;">${new Date(incident.timestamp || incident.created_at).toLocaleString('en-GB', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric', 
                            hour: '2-digit', 
                            minute: '2-digit', 
                            second: '2-digit' 
                        })}</p>
                    </div>
                    
                    <div>
                        <strong style="color: var(--primary); font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; display: block;">Root Cause</strong>
                        <p style="margin: 5px 0; color: var(--text-primary);">${additionalDetails.root_cause}</p>
                    </div>
                    
                    <div>
                        <strong style="color: var(--primary); font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; display: block;">Error Details</strong>
                        <p style="margin: 5px 0; color: var(--text-secondary); background: var(--bg-main); padding: 15px; border-radius: 8px; line-height: 1.5; border-left: 4px solid var(--primary);">${additionalDetails.error_details}</p>
                    </div>
                    
                    <div>
                        <strong style="color: var(--primary); font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; display: block;">Escalation Level</strong>
                        <p style="margin: 5px 0; color: var(--text-primary);">${additionalDetails.escalation_level}</p>
                    </div>
                    
                    <div>
                        <strong style="color: var(--primary); font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; display: block;">Resolution Steps</strong>
                        <div style="background: var(--bg-main); padding: 15px; border-radius: 8px; border-left: 4px solid var(--success);">
                            ${additionalDetails.resolution_steps.map((step, index) => 
                                `<div style="display: flex; align-items: center; margin: 8px 0; color: var(--text-secondary);">
                                    <span style="background: var(--success); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.8em; margin-right: 10px;">${index + 1}</span>
                                    ${step}
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                    
                    <div>
                        <strong style="color: var(--primary); font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; display: block;">Tags</strong>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            ${additionalDetails.tags.map(tag => 
                                `<span style="background: var(--primary); color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.8em;">${tag}</span>`
                            ).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            const modal = document.getElementById('incidentModal');
            if (modal) {
                modal.style.display = 'block';
                console.log('Modal should now be visible');
            } else {
                console.error('Modal element not found');
            }
        }

        function closeIncidentModal() {
            document.getElementById('incidentModal').style.display = 'none';
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('incidentModal');
            if (event.target === modal) {
                closeIncidentModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeIncidentModal();
            }
        });

        // API Calls (restored from original)
        async function fetchStats() {
            try {
                console.log('Fetching stats...');
                const response = await fetch('/api/stats');
                if (!response.ok) {
                    throw new Error(`Stats API failed: ${response.status}`);
                }
                const data = await response.json();
                console.log('Stats received:', data);
                return data;
            } catch (error) {
                console.error('Error fetching stats:', error);
                return null;
            }
        }

        // Update Functions (restored to handle real API data)
        function updateMetrics(stats, incidents) {
            console.log('Updating metrics with:', { stats, incidentsLength: incidents?.length });
            
            // Update basic metrics from real API data
            const totalIncidents = stats?.total_incidents || 0;
            document.getElementById('totalIncidents').textContent = totalIncidents.toLocaleString();
            document.getElementById('mlConfidence').textContent = (stats?.ml_confidence || 94) + '%';
            
            if (incidents && incidents.length > 0) {
                const criticalCount = incidents.filter(i => i.severity === 'critical').length;
                const totalImpact = incidents.reduce((sum, i) => sum + (i.business_impact || 0), 0);
                const avgDuration = incidents.reduce((sum, i) => sum + (i.duration_minutes || 0), 0) / incidents.length;
                
                document.getElementById('criticalActive').textContent = criticalCount;
                document.getElementById('avgResolution').textContent = Math.round(avgDuration) + 'm';
                
                // Format total impact properly
                if (totalImpact >= 1000000) {
                    document.getElementById('totalImpact').textContent = '£' + (totalImpact / 1000000).toFixed(1) + 'M';
                } else if (totalImpact >= 1000) {
                    document.getElementById('totalImpact').textContent = '£' + (totalImpact / 1000).toFixed(1) + 'K';
                } else {
                    document.getElementById('totalImpact').textContent = '£' + totalImpact.toLocaleString();
                }
                
                console.log('Metrics updated:', { totalIncidents, criticalCount, totalImpact, avgDuration });
            } else {
                console.log('No incidents for metrics calculation');
                document.getElementById('criticalActive').textContent = '0';
                document.getElementById('avgResolution').textContent = '0m';
                document.getElementById('totalImpact').textContent = '£0';
            }
            
            const incidentsPerHour = stats?.incidents_per_hour || 0;
            document.getElementById('incidentsChange').textContent = `⚡ ${incidentsPerHour.toFixed(1)}/hour`;
            document.getElementById('criticalChange').textContent = 'Active now';
            document.getElementById('resolutionChange').textContent = 'ML optimized';
            document.getElementById('impactChange').textContent = 'Live tracking';
            document.getElementById('confidenceChange').textContent = 'Improving';
        }

        function updateAlertBar(stats) {
            const alertText = document.getElementById('alertText');
            const opportunities = stats?.opportunity_count || 0;
            const confidence = stats?.ml_confidence || 94;
            const totalIncidents = stats?.total_incidents || 0;
            alertText.textContent = `Live System: ${totalIncidents} incidents analyzed • ${opportunities} business opportunities identified • ML confidence: ${confidence}%`;
            console.log('Alert bar updated:', { totalIncidents, opportunities, confidence });
        }

        async function fetchIncidents() {
            try {
                console.log('Fetching incidents...');
                const response = await fetch('/api/incidents/recent');
                if (!response.ok) {
                    throw new Error(`Incidents API failed: ${response.status}`);
                }
                const data = await response.json();
                console.log('Incidents received:', data?.length || 0, 'incidents');
                return data || [];
            } catch (error) {
                console.error('Error fetching incidents:', error);
                return [];
            }
        }

        async function fetchOpportunities() {
            try {
                console.log('Fetching opportunities...');
                const response = await fetch('/api/opportunities/latest');
                if (!response.ok) {
                    throw new Error(`Opportunities API failed: ${response.status}`);
                }
                const data = await response.json();
                console.log('Opportunities received:', data?.length || 0, 'opportunities');
                return data || [];
            } catch (error) {
                console.error('Error fetching opportunities:', error);
                return [];
            }
        }

        async function fetchDetailedAnalysis() {
            try {
                console.log('Fetching detailed analysis...');
                const response = await fetch('/api/analysis/detailed');
                if (!response.ok) {
                    throw new Error(`Analysis API failed: ${response.status}`);
                }
                const data = await response.json();
                console.log('Analysis received:', data);
                return data;
            } catch (error) {
                console.error('Error fetching analysis:', error);
                return null;
            }
        }

        async function fetchProviderReliability() {
            try {
                console.log('Fetching provider reliability...');
                const response = await fetch('/api/providers/reliability');
                if (!response.ok) {
                    throw new Error(`Providers API failed: ${response.status}`);
                }
                const data = await response.json();
                console.log('Providers received:', data?.length || 0, 'providers');
                return data || [];
            } catch (error) {
                console.error('Error fetching provider data:', error);
                return [];
            }
        }

        // Tab Management
        function switchMainTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.main-tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            currentMainTab = tabName;
            
            if (tabName === 'incident-intelligence') {
                switchSubTab('overview');
            } else {
                switchSubTab('opportunities-overview');
            }
        }

        function switchSubTab(tabName) {
            const currentMainContent = document.getElementById(currentMainTab);
            currentMainContent.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            currentMainContent.querySelectorAll('.sub-tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            if (event && event.target) event.target.classList.add('active');
            currentSubTab = tabName;
            
            setTimeout(() => loadTabData(tabName), 100);
        }

        function loadTabData(tabName) {
            switch(tabName) {
                case 'overview':
                    loadOverviewData();
                    break;
                case 'real-time':
                    loadRealTimeData();
                    break;
                case 'analytics':
                    loadAnalyticsData();
                    break;
                case 'opportunities-overview':
                    loadOpportunitiesData();
                    break;
            }
        }

        // Data Loading Functions (restored to use real APIs)
        async function loadOverviewData() {
            console.log('Loading overview data...');
            
            try {
                const [stats, incidents, providers] = await Promise.all([
                    fetchStats(),
                    fetchIncidents(),
                    fetchProviderReliability()
                ]);
                
                console.log('Data loaded:', { 
                    stats, 
                    incidentsCount: incidents?.length, 
                    providersCount: providers?.length,
                    providersStructure: providers?.[0],
                    incidentsStructure: incidents?.[0]
                });
                
                // Update metrics first
                if (stats) {
                    updateMetrics(stats, incidents || []);
                    updateAlertBar(stats);
                } else {
                    console.log('No stats received - using default values');
                    updateMetrics({}, []);
                    updateAlertBar({});
                }
                
                // Update charts with real data
                updateTrendChart(incidents || []);
                updateProviderChart(providers || []);
                updateSeverityChart(incidents || []);
                updateErrorTypeChart(incidents || []);
                updateGenerationChart(stats || {});
                
                console.log('All charts updated with real data');
                
            } catch (error) {
                console.error('Error loading overview data:', error);
                // Ensure functions exist before calling them
                if (typeof updateMetrics === 'function') updateMetrics({}, []);
                if (typeof updateAlertBar === 'function') updateAlertBar({});
                if (typeof updateTrendChart === 'function') updateTrendChart([]);
                if (typeof updateProviderChart === 'function') updateProviderChart([]);
                if (typeof updateSeverityChart === 'function') updateSeverityChart([]);
                if (typeof updateErrorTypeChart === 'function') updateErrorTypeChart([]);
                if (typeof updateGenerationChart === 'function') updateGenerationChart({});
            }
        }

        async function loadRealTimeData() {
            const incidents = await fetchIncidents();
            updateIncidentStream(incidents);
            
            const stats = await fetchStats();
            updateSystemStatsChart(stats || {});
        }

        async function loadAnalyticsData() {
            const analysis = await fetchDetailedAnalysis();
            const incidents = await fetchIncidents();
            
            if (analysis && incidents.length > 0) {
                updateStatisticalChart(incidents);
                updateClusteringChart(incidents);
                updateAnomalyChart(incidents);
                updateForecastChart(incidents);
                updateFeatureImportanceChart(analysis);
            }
        }

        async function loadOpportunitiesData() {
            const opportunities = await fetchOpportunities();
            updateOpportunitiesMetrics(opportunities);
            updateOpportunitiesStream(opportunities);
        }

        // Chart Update Functions using Plotly
        function updateTrendChart(incidents) {
            const last7Days = [];
            const now = new Date();
            for (let i = 6; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);
                last7Days.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
            }
            
            const dailyCounts = new Array(7).fill(0);
            const dailyImpacts = new Array(7).fill(0);
            
            incidents.forEach(incident => {
                const incidentDate = new Date(incident.timestamp);
                const daysDiff = Math.floor((now - incidentDate) / (1000 * 60 * 60 * 24));
                if (daysDiff >= 0 && daysDiff < 7) {
                    const index = 6 - daysDiff;
                    dailyCounts[index]++;
                    dailyImpacts[index] += incident.business_impact;
                }
            });
            
            const trace1 = {
                x: last7Days,
                y: dailyCounts,
                name: 'Incidents',
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#667eea', width: 3 },
                marker: { size: 8 }
            };
            
            const trace2 = {
                x: last7Days,
                y: dailyImpacts.map(i => i / 1000),
                name: 'Impact (£k)',
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#f56565', width: 3 },
                marker: { size: 8 },
                yaxis: 'y2'
            };
            
            const layout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: getComputedStyle(document.body).getPropertyValue('--text-primary') },
                margin: { l: 40, r: 40, t: 10, b: 40 },
                xaxis: { showgrid: false },
                yaxis: { title: 'Incidents', showgrid: true, gridcolor: '#e2e8f0' },
                yaxis2: {
                    title: 'Impact (£k)',
                    overlaying: 'y',
                    side: 'right',
                    showgrid: false
                },
                legend: { x: 0, y: 1 }
            };
            
            Plotly.newPlot('trendChart', [trace1, trace2], layout, {responsive: true});
        }

        function updateProviderChart(providers) {
            console.log('Updating provider chart with', providers?.length, 'providers');
            console.log('Provider data:', providers);
            
            if (!providers || providers.length === 0) {
                console.log('No providers for chart - creating empty chart');
                const data = [{
                    values: [1],
                    labels: ['No Data'],
                    type: 'pie',
                    marker: { colors: ['#667eea'] }
                }];
                
                const layout = {
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { color: getComputedStyle(document.body).getPropertyValue('--text-primary') },
                    margin: { l: 20, r: 20, t: 20, b: 20 },
                    showlegend: true,
                    legend: { x: 0, y: 0 }
                };
                
                Plotly.newPlot('providerChart', data, layout, {responsive: true});
                return;
            }
            
            try {
                // Handle different possible data structures from API
                let labels, values;
                
                if (providers[0]?.provider) {
                    // Format: [{provider: "AWS", incidents: 10}, ...]
                    labels = providers.map(p => p.provider);
                    values = providers.map(p => p.incidents || p.incident_count || p.reliability_score || 1);
                } else if (providers[0]?.service_provider) {
                    // Format: [{service_provider: "AWS", incident_count: 10}, ...]
                    labels = providers.map(p => p.service_provider);
                    values = providers.map(p => p.incident_count || p.incidents || p.reliability_score || 1);
                } else {
                    // Fallback: assume it's incident data, group by provider
                    const providerCounts = {};
                    providers.forEach(item => {
                        const provider = item.service_provider || item.provider || 'Unknown';
                        providerCounts[provider] = (providerCounts[provider] || 0) + 1;
                    });
                    labels = Object.keys(providerCounts);
                    values = Object.values(providerCounts);
                }
                
                console.log('Chart data:', { labels, values });
                
                const data = [{
                    values: values,
                    labels: labels,
                    type: 'pie',
                    marker: {
                        colors: ['#667eea', '#f56565', '#48bb78', '#ed8936', '#9f7aea', '#805ad5', '#38b2ac', '#dd6b20']
                    }
                }];
                
                const layout = {
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { color: getComputedStyle(document.body).getPropertyValue('--text-primary') },
                    margin: { l: 20, r: 20, t: 20, b: 20 },
                    showlegend: true,
                    legend: { x: 0, y: 0 }
                };
                
                Plotly.newPlot('providerChart', data, layout, {responsive: true});
                console.log('Provider chart updated successfully with real data');
            } catch (error) {
                console.error('Error updating provider chart:', error);
                console.log('Provider data that caused error:', providers);
            }
        }

        function updateGenerationChart(stats) {
            console.log('Updating generation chart with stats:', stats);
            
            try {
                const rate = stats?.incidents_per_hour || 0;
                const times = ['5min ago', '4min ago', '3min ago', '2min ago', '1min ago', 'Now'];
                
                // Use real rate or simulate recent values
                const rates = stats?.recent_rates || [rate, rate, rate, rate, rate, rate];
                
                const data = [{
                    x: times,
                    y: rates,
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: { color: '#48bb78', width: 3 },
                    marker: { size: 8 },
                    fill: 'tonexty'
                }];
                
                const layout = {
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { color: getComputedStyle(document.body).getPropertyValue('--text-primary') },
                    margin: { l: 40, r: 20, t: 10, b: 40 },
                    xaxis: { showgrid: false },
                    yaxis: { title: 'Rate/Hour', showgrid: true, gridcolor: '#e2e8f0' },
                    showlegend: false
                };
                
                Plotly.newPlot('generationChart', data, layout, {responsive: true});
                console.log('Generation chart updated successfully with rate:', rate);
            } catch (error) {
                console.error('Error updating generation chart:', error);
            }
        }

        function updateSeverityChart(incidents) {
            const severityCounts = {};
            incidents.forEach(incident => {
                severityCounts[incident.severity] = (severityCounts[incident.severity] || 0) + 1;
            });
            
            const data = [{
                values: Object.values(severityCounts),
                labels: Object.keys(severityCounts),
                type: 'pie',
                marker: {
                    colors: ['#f56565', '#ed8936', '#9f7aea', '#48bb78']
                }
            }];
            
            const layout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: getComputedStyle(document.body).getPropertyValue('--text-primary') },
                margin: { l: 10, r: 10, t: 10, b: 10 },
                showlegend: true,
                legend: { x: 0, y: 0 }
            };
            
            Plotly.newPlot('severityChart', data, layout, {responsive: true});
        }

        function updateErrorTypeChart(incidents) {
            const errorTypes = {};
            incidents.forEach(incident => {
                if (!errorTypes[incident.error_type]) {
                    errorTypes[incident.error_type] = { count: 0, impact: 0 };
                }
                errorTypes[incident.error_type].count++;
                errorTypes[incident.error_type].impact += incident.business_impact;
            });
            
            const sortedTypes = Object.entries(errorTypes)
                .sort((a, b) => b[1].impact - a[1].impact)
                .slice(0, 5);
            
            const data = [{
                x: sortedTypes.map(t => t[1].impact / 1000),
                y: sortedTypes.map(t => t[0]),
                type: 'bar',
                orientation: 'h',
                marker: { color: '#ed8936' }
            }];
            
            const layout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: getComputedStyle(document.body).getPropertyValue('--text-primary') },
                margin: { l: 120, r: 20, t: 10, b: 40 },
                xaxis: { title: 'Impact (£k)', showgrid: true, gridcolor: '#e2e8f0' },
                yaxis: { showgrid: false }
            };
            
            Plotly.newPlot('errorTypeChart', data, layout, {responsive: true});
        }

        function updateGenerationChart() {
            const times = ['5min ago', '4min ago', '3min ago', '2min ago', '1min ago', 'Now'];
            const rates = [22.3, 24.1, 23.8, 25.2, 24.7, 24.3];
            
            const data = [{
                x: times,
                y: rates,
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#48bb78', width: 3 },
                marker: { size: 8 },
                fill: 'tonexty'
            }];
            
            const layout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: getComputedStyle(document.body).getPropertyValue('--text-primary') },
                margin: { l: 40, r: 20, t: 10, b: 40 },
                xaxis: { showgrid: false },
                yaxis: { title: 'Rate/Hour', showgrid: true, gridcolor: '#e2e8f0' },
                showlegend: false
            };
            
            Plotly.newPlot('generationChart', data, layout, {responsive: true});
        }

        function updateSystemStatsChart(stats) {
            console.log('Updating system stats chart with:', stats);
            
            try {
                // Use stats data if available, otherwise use defaults
                const systemHealth = stats?.system_health || 98;
                const dataQuality = stats?.data_quality || 92;
                const mlAccuracy = stats?.ml_confidence || 94;
                const uptime = stats?.uptime || 99;
                const generationRate = Math.min(100, (stats?.incidents_per_hour || 25) * 4); // Scale to 0-100
                
                const data = [{
                    type: 'scatterpolar',
                    r: [generationRate, systemHealth, dataQuality, mlAccuracy, uptime],
                    theta: ['Generation Rate', 'System Health', 'Data Quality', 'ML Accuracy', 'Uptime'],
                    fill: 'toself',
                    marker: { color: '#667eea' },
                    line: { color: '#667eea' }
                }];
                
                const layout = {
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { color: getComputedStyle(document.body).getPropertyValue('--text-primary') },
                    polar: {
                        radialaxis: {
                            visible: true,
                            range: [0, 100]
                        }
                    },
                    margin: { l: 20, r: 20, t: 20, b: 20 }
                };
                
                Plotly.newPlot('systemStatsChart', data, layout, {responsive: true});
                console.log('System stats chart updated successfully');
            } catch (error) {
                console.error('Error updating system stats chart:', error);
            }
        }

        function updateStatisticalChart(incidents) {
            const impacts = incidents.map(i => i.business_impact);
            const bins = [0, 1000, 5000, 10000, 25000, 50000];
            const binCounts = new Array(bins.length - 1).fill(0);
            
            impacts.forEach(impact => {
                for (let i = 0; i < bins.length - 1; i++) {
                    if (impact >= bins[i] && impact < bins[i + 1]) {
                        binCounts[i]++;
                        break;
                    }
                }
            });
            
            const data = [{
                x: ['£0-1k', '£1k-5k', '£5k-10k', '£10k-25k', '£25k-50k'],
                y: binCounts,
                type: 'bar',
                marker: { color: '#667eea' }
            }];
            
            const layout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: getComputedStyle(document.body).getPropertyValue('--text-primary') },
                margin: { l: 40, r: 20, t: 10, b: 40 },
                xaxis: { showgrid: false },
                yaxis: { title: 'Frequency', showgrid: true, gridcolor: '#e2e8f0' }
            };
            
            Plotly.newPlot('statisticalChart', data, layout, {responsive: true});
        }

        function updateClusteringChart(incidents) {
            const providers = {};
            incidents.forEach(incident => {
                if (!providers[incident.service_provider]) {
                    providers[incident.service_provider] = { count: 0, totalImpact: 0 };
                }
                providers[incident.service_provider].count++;
                providers[incident.service_provider].totalImpact += incident.business_impact;
            });
            
            const providerData = Object.entries(providers).map(([name, data]) => ({
                name,
                count: data.count,
                avgImpact: data.totalImpact / data.count
            }));
            
            const data = [{
                x: providerData.map(p => p.count),
                y: providerData.map(p => p.avgImpact),
                mode: 'markers',
                type: 'scatter',
                marker: { 
                    size: 12,
                    color: providerData.map(p => p.avgImpact),
                    colorscale: 'Viridis'
                },
                text: providerData.map(p => p.name)
            }];
            
            const layout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: getComputedStyle(document.body).getPropertyValue('--text-primary') },
                margin: { l: 40, r: 20, t: 10, b: 40 },
                xaxis: { title: 'Incident Count', showgrid: true, gridcolor: '#e2e8f0' },
                yaxis: { title: 'Avg Impact', showgrid: true, gridcolor: '#e2e8f0' }
            };
            
            Plotly.newPlot('clusteringChart', data, layout, {responsive: true});
        }

        function updateAnomalyChart(incidents) {
            const impacts = incidents.map(i => i.business_impact);
            const mean = impacts.reduce((a, b) => a + b, 0) / impacts.length;
            const std = Math.sqrt(impacts.reduce((sq, n) => sq + Math.pow(n - mean, 2), 0) / impacts.length);
            const threshold = mean + (2 * std);
            
            const normalCount = impacts.filter(i => i <= threshold).length;
            const anomalyCount = impacts.filter(i => i > threshold).length;
            
            const data = [{
                values: [normalCount, anomalyCount],
                labels: ['Normal', 'Anomalies'],
                type: 'pie',
                marker: {
                    colors: ['#48bb78', '#f56565']
                }
            }];
            
            const layout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: getComputedStyle(document.body).getPropertyValue('--text-primary') },
                margin: { l: 10, r: 10, t: 10, b: 10 }
            };
            
            Plotly.newPlot('anomalyChart', data, layout, {responsive: true});
        }

        function updateForecastChart(incidents) {
            const next7Days = [];
            for (let i = 1; i <= 7; i++) {
                const date = new Date();
                date.setDate(date.getDate() + i);
                next7Days.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
            }
            
            // Simple forecast simulation
            const forecast = [18, 22, 26, 24, 20, 16, 19];
            
            const data = [{
                x: next7Days,
                y: forecast,
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#667eea', width: 3 },
                marker: { size: 8 },
                fill: 'tonexty'
            }];
            
            const layout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: getComputedStyle(document.body).getPropertyValue('--text-primary') },
                margin: { l: 40, r: 20, t: 10, b: 40 },
                xaxis: { showgrid: false },
                yaxis: { title: 'Predicted Incidents', showgrid: true, gridcolor: '#e2e8f0' }
            };
            
            Plotly.newPlot('forecastChart', data, layout, {responsive: true});
        }

        function updateFeatureImportanceChart() {
            const features = ['Service Provider', 'Error Type', 'Severity', 'Time of Day', 'Duration'];
            const importance = [0.35, 0.28, 0.22, 0.10, 0.05];
            
            const data = [{
                x: importance,
                y: features,
                type: 'bar',
                orientation: 'h',
                marker: { color: '#667eea' }
            }];
            
            const layout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: getComputedStyle(document.body).getPropertyValue('--text-primary') },
                margin: { l: 100, r: 20, t: 10, b: 40 },
                xaxis: { title: 'Importance Score', showgrid: true, gridcolor: '#e2e8f0' },
                yaxis: { showgrid: false }
            };
            
            Plotly.newPlot('featureImportanceChart', data, layout, {responsive: true});
        }

        function updateIncidentStream(incidents) {
            const stream = document.getElementById('incidentStream');
            
            if (!incidents || incidents.length === 0) {
                stream.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">No incidents to display</div>';
                return;
            }
            
            const recentIncidents = incidents.slice(0, 8);
            currentIncidents = recentIncidents; // Store for modal access
            
            stream.innerHTML = recentIncidents.map((incident, index) => {
                const time = new Date(incident.timestamp || incident.created_at).toLocaleTimeString();
                const impact = incident.business_impact ? `£${(incident.business_impact / 1000).toFixed(1)}k` : '£0';
                
                return `
                    <div class="incident-item" onclick="showIncidentFromStream(${index})" style="cursor: pointer;">
                        <div class="incident-header">
                            <div class="incident-title">${incident.error_type || 'Unknown Error'}</div>
                            <div class="severity-badge severity-${incident.severity || 'unknown'}">${incident.severity || 'unknown'}</div>
                        </div>
                        <div class="incident-meta">
                            ${time} • ${incident.service_provider || 'Unknown Provider'} • Impact: ${impact} • Duration: ${incident.duration_minutes || 0}m
                        </div>
                    </div>
                `;
            }).join('');
            
            console.log('Incident stream updated with', recentIncidents.length, 'clickable incidents');
        }
        
        function showIncidentFromStream(index) {
            console.log('showIncidentFromStream called with index:', index);
            console.log('currentIncidents:', currentIncidents);
            if (currentIncidents[index]) {
                showIncidentDetails(currentIncidents[index]);
            } else {
                console.error('No incident found at index:', index);
            }
        }

        function updateOpportunitiesMetrics(opportunities) {
            if (!opportunities || opportunities.length === 0) {
                document.getElementById('totalRevenue').textContent = '£0';
                document.getElementById('opportunityCount').textContent = '0';
                document.getElementById('avgROI').textContent = '0%';
                document.getElementById('implementationCost').textContent = '£0';
                return;
            }
            
            const totalRevenue = opportunities.reduce((sum, opp) => sum + (opp.revenue_potential || 0), 0);
            const avgROI = opportunities.length > 0 ? 
                opportunities.reduce((sum, opp) => sum + (opp.roi_percentage || 0), 0) / opportunities.length : 0;
            const totalCost = opportunities.reduce((sum, opp) => sum + (opp.implementation_cost || 0), 0);
            
            // Format revenue properly
            if (totalRevenue >= 1000000) {
                document.getElementById('totalRevenue').textContent = `£${(totalRevenue / 1000000).toFixed(1)}M`;
            } else if (totalRevenue >= 1000) {
                document.getElementById('totalRevenue').textContent = `£${(totalRevenue / 1000).toFixed(1)}K`;
            } else {
                document.getElementById('totalRevenue').textContent = `£${totalRevenue.toLocaleString()}`;
            }
            
            document.getElementById('opportunityCount').textContent = opportunities.length;
            document.getElementById('avgROI').textContent = `${Math.round(avgROI)}%`;
            
            // Format implementation cost properly
            if (totalCost >= 1000000) {
                document.getElementById('implementationCost').textContent = `£${(totalCost / 1000000).toFixed(1)}M`;
            } else if (totalCost >= 1000) {
                document.getElementById('implementationCost').textContent = `£${(totalCost / 1000).toFixed(1)}K`;
            } else {
                document.getElementById('implementationCost').textContent = `£${totalCost.toLocaleString()}`;
            }
        }

        function updateOpportunitiesStream(opportunities) {
            const stream = document.getElementById('opportunitiesStream');
            
            if (!opportunities || opportunities.length === 0) {
                stream.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">No opportunities discovered yet. Complete 2500 incidents for ML analysis.</div>';
                return;
            }
            
            stream.innerHTML = opportunities.map(opp => {
                const revenue = opp.revenue_potential || 0;
                let revenueDisplay;
                if (revenue >= 1000000) {
                    revenueDisplay = `£${(revenue / 1000000).toFixed(1)}M`;
                } else if (revenue >= 1000) {
                    revenueDisplay = `£${(revenue / 1000).toFixed(1)}K`;
                } else {
                    revenueDisplay = `£${revenue.toLocaleString()}`;
                }
                
                return `
                    <div class="opportunity-card">
                        <div class="opportunity-header">
                            <div class="opportunity-title">${opp.opportunity_type || 'Business Opportunity'}</div>
                            <div class="opportunity-value">${revenueDisplay}</div>
                        </div>
                        <div class="opportunity-meta">
                            <span>ROI: ${opp.roi_percentage || 0}%</span>
                            <span>Confidence: ${opp.confidence_score || 0}%</span>
                            <span>Market: ${opp.market_size || 'TBD'}</span>
                        </div>
                        <div class="opportunity-description">
                            ${opp.description || 'Detailed analysis pending...'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Theme Toggle
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            body.setAttribute('data-theme', newTheme);
            
            const button = document.querySelector('.theme-toggle');
            button.textContent = newTheme === 'light' ? '🌙 Dark Mode' : '☀️ Light Mode';
            
            // Refresh charts with new theme
            if (currentSubTab) {
                setTimeout(() => loadTabData(currentSubTab), 100);
            }
        }

        // Initialize Dashboard (restored to use real APIs)
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard initializing with real API integration...');
            
            // Set initial loading message
            document.getElementById('alertText').textContent = 'System Online: Loading real-time incident data...';
            
            // Load real data for all tabs
            loadOverviewData();
            loadRealTimeData(); // Pre-load incident stream
            
            // Update every 5 seconds with real data
            updateInterval = setInterval(() => {
                console.log('Refreshing data...');
                if (currentMainTab === 'incident-intelligence') {
                    loadTabData(currentSubTab);
                } else if (currentMainTab === 'business-opportunities') {
                    loadOpportunitiesData();
                }
            }, 5000);
        });
    </script>
</body>
</html>
